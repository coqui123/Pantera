{% extends "base.html" %}

{% block title %}Admin Dashboard - Mango Data Service{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Hero Section -->
    <div class="gradient-bg rounded-lg shadow-xl p-4 sm:p-6 lg:p-8 mb-6 sm:mb-8 text-white">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2 sm:mb-4">ðŸ¥­ Mango Data Service</h1>
            <p class="text-base sm:text-lg lg:text-xl mb-4 sm:mb-6">Admin Dashboard - High-Performance Yahoo Finance API with Web Management</p>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mt-4 sm:mt-8">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold">50-80%</div>
                    <div class="text-sm">Memory Reduction</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold">3x</div>
                    <div class="text-sm">Faster Caching</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold">100</div>
                    <div class="text-sm">Req/Min Rate Limit</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-2xl font-bold">&lt;100ms</div>
                    <div class="text-sm">Response Time</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Section -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
            <div>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">
                    <i class="fas fa-wallet text-yellow-500 mr-2"></i>My Portfolio
                </h2>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-sync-alt mr-1"></i>Auto-updates every 30 seconds
                </p>
            </div>
            <button onclick="refreshPortfolio()" id="refreshPortfolioBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm transition duration-200 w-full sm:w-auto">
                <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
        </div>
        <div id="portfolioContent">
            <div class="text-center py-4">
                <div class="loading mx-auto mb-2"></div>
                <p class="text-gray-600">Loading portfolio...</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 sm:mb-8">
        <!-- Symbol Management -->
        <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-cogs text-blue-500 mr-2"></i>Symbol Management
            </h2>
            <p class="text-gray-600 mb-4">Add new symbols to database or search existing ones</p>
                <form id="quickAddForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add Symbol to Database</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="quickSymbolInput" placeholder="e.g., META, NVDA, AMZN" 
                               class="flex-1 border border-gray-300 rounded-md sm:rounded-l-md sm:rounded-r-none px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" id="quickAddBtn" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 sm:px-6 py-2 rounded-md sm:rounded-r-md sm:rounded-l-none transition duration-200 w-full sm:w-auto">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                </div>
            </form>
            <div id="quickAddResult" class="mt-4"></div>
            <div class="mt-4">
                <a href="/ui/search" class="inline-flex items-center justify-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition duration-200 w-full sm:w-auto">
                    <i class="fas fa-search mr-2"></i>Full Management
                </a>
            </div>
        </div>

        <!-- System Health -->
        <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-heartbeat text-green-500 mr-2"></i>System Status
            </h2>
            <div id="healthStatus">
                <div class="text-center py-4">
                    <div class="loading mx-auto mb-2"></div>
                    <p class="text-gray-600">Loading system status...</p>
                </div>
            </div>
            <div id="databaseStats" class="mt-4">
                <div class="text-center py-4">
                    <div class="loading mx-auto mb-2"></div>
                    <p class="text-gray-600">Loading database stats...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Overview -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">
                <i class="fas fa-database text-purple-500 mr-2"></i>Database Overview
            </h2>
            <button onclick="refreshStats()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md text-sm transition duration-200 w-full sm:w-auto">
                <i class="fas fa-refresh mr-1"></i>Refresh
            </button>
        </div>
        <div id="recentSymbols">
            <div class="text-center py-4">
                <div class="loading mx-auto mb-2"></div>
                <p class="text-gray-600">Loading recent symbols...</p>
            </div>
        </div>
    </div>

    <!-- Features Showcase -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-rocket text-blue-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">High Performance</h3>
                <p class="text-gray-600">Zero-copy operations and concurrent caching for maximum throughput</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-green-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">Enterprise Security</h3>
                <p class="text-gray-600">Rate limiting, input validation, and secure error handling</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 card-hover">
            <div class="text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-purple-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">Rich Analytics</h3>
                <p class="text-gray-600">Advanced financial analytics with technical indicators</p>
            </div>
        </div>
    </div>

    <!-- API Endpoints -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-gray-800">
            <i class="fas fa-code text-indigo-500 mr-2"></i>Available API Endpoints
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Core Endpoints</h3>
                <div class="space-y-2">
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium mr-3">GET</span>
                        <code class="text-sm">/health</code>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium mr-3">GET</span>
                        <code class="text-sm">/api/symbols/search</code>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium mr-3">GET</span>
                        <code class="text-sm">/api/symbols/{symbol}/validate</code>
                    </div>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Data Endpoints</h3>
                <div class="space-y-2">
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium mr-3">GET</span>
                        <code class="text-sm">/api/symbols/{symbol}/quote</code>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-3">POST</span>
                        <code class="text-sm">/api/symbols/{symbol}/fetch</code>
                    </div>
                    <div class="flex items-center p-2 bg-gray-50 rounded">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium mr-3">GET</span>
                        <code class="text-sm">/api/symbols/{symbol}/comprehensive</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4 sm:mt-6 text-center space-y-2 sm:space-y-0 sm:space-x-4">
            <a href="/ui/search" class="inline-flex items-center justify-center px-4 sm:px-6 py-2 sm:py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-lg transition duration-200 w-full sm:w-auto">
                <i class="fas fa-cogs mr-2"></i>Manage Symbols
            </a>
            <a href="/ui/analytics" class="inline-flex items-center justify-center px-4 sm:px-6 py-2 sm:py-3 bg-purple-500 hover:bg-purple-600 text-white font-medium rounded-lg transition duration-200 w-full sm:w-auto">
                <i class="fas fa-chart-bar mr-2"></i>View Analytics
            </a>
        </div>
    </div>
</div>

<script>
    // Quick add symbol
    async function quickAddSymbol(symbol) {
        try {
            // First validate the symbol
            const validateResponse = await fetch(`/api/symbols/${symbol}/validate`);
            const validateData = await validateResponse.json();
            
            if (!validateData.success || !validateData.data.valid) {
                document.getElementById('quickAddResult').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <div class="flex items-center">
                            <i class="fas fa-times-circle text-red-500 mr-2"></i>
                            <span class="font-medium text-red-800">Invalid Symbol: ${symbol}</span>
                        </div>
                    </div>
                `;
                return;
            }

            // Fetch historical data
            const fetchResponse = await fetch(`/api/symbols/${symbol}/fetch?interval=1d`, {
                method: 'POST'
            });
            const fetchData = await fetchResponse.json();
            
            if (fetchData.success) {
                document.getElementById('quickAddResult').innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded p-3">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="font-medium text-green-800">Successfully Added: ${symbol}</span>
                        </div>
                        <div class="mt-2">
                            <a href="/ui/analytics?symbol=${symbol}" class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-chart-line mr-1"></i>View Analytics
                            </a>
                        </div>
                    </div>
                `;
                // Refresh stats
                setTimeout(() => {
                    refreshStats();
                    loadRecentSymbols();
                }, 1000);
            } else {
                document.getElementById('quickAddResult').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <div class="text-red-800">Failed to fetch data for: ${symbol}</div>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('quickAddResult').innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded p-3">
                    <div class="text-red-800">Error adding symbol</div>
                </div>
            `;
        }
    }

    // Load system health
    async function loadHealth() {
        try {
            const response = await fetch('/health');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('healthStatus').innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Status:</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">
                                <i class="fas fa-check-circle mr-1"></i>Healthy
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Version:</span>
                            <span class="text-gray-600">${data.data.version}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Features:</span>
                            <span class="text-gray-600">${data.data.features.length} active</span>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('healthStatus').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-2"></i>
                    <p class="text-red-600">Health check failed</p>
                </div>
            `;
        }
    }

    // Load database stats
    async function loadDatabaseStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            if (data.success) {
                const stats = data.data;
                document.getElementById('databaseStats').innerHTML = `
                    <div class="border-t pt-4">
                        <h3 class="font-semibold mb-2 text-gray-700">Database Statistics</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Total Symbols:</span>
                                <span class="font-medium">${stats.total_symbols || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Historical Records:</span>
                                <span class="font-medium">${stats.total_historical_prices || 0}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cache Entries:</span>
                                <span class="font-medium">${stats.cache_entries || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('databaseStats').innerHTML = `
                <div class="border-t pt-4">
                    <div class="text-red-600 text-sm">Error loading database stats</div>
                </div>
            `;
        }
    }

    // Load recent symbols
    async function loadRecentSymbols() {
        try {
            const response = await fetch('/api/symbols');
            const data = await response.json();
            
            if (data.success && data.data.length > 0) {
                const recent = data.data.slice(0, 5); // Show last 5 symbols
                const recentHtml = recent.map(symbol => `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded mb-2">
                        <div>
                            <span class="font-semibold">${symbol.symbol}</span>
                            <span class="text-gray-600 ml-2">${symbol.name || 'No name'}</span>
                        </div>
                        <a href="/ui/analytics?symbol=${symbol.symbol}" 
                           class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            View
                        </a>
                    </div>
                `).join('');
                
                document.getElementById('recentSymbols').innerHTML = `
                    <div class="mb-3">
                        <span class="text-sm text-gray-600">Recent symbols (${data.data.length} total)</span>
                    </div>
                    ${recentHtml}
                    ${data.data.length > 5 ? `
                    <div class="text-center mt-3">
                        <a href="/ui/search" class="text-blue-600 hover:text-blue-800 text-sm">
                            View all ${data.data.length} symbols â†’
                        </a>
                    </div>
                    ` : ''}
                `;
            } else {
                document.getElementById('recentSymbols').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-database text-gray-400 text-3xl mb-3"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No symbols in database</h3>
                        <p class="text-gray-500 mb-4">Start by adding some symbols above</p>
                        <a href="/ui/search" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Symbols
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('recentSymbols').innerHTML = `
                <div class="text-center py-4 text-red-600">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <p>Error loading symbols</p>
                </div>
            `;
        }
    }

    function refreshStats() {
        loadHealth();
        loadDatabaseStats();
        loadRecentSymbols();
    }

    // Quick add form handler
    document.getElementById('quickAddForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const symbol = document.getElementById('quickSymbolInput').value.trim().toUpperCase();
        
        if (!symbol) {
            document.getElementById('quickAddResult').innerHTML = '<div class="text-red-600">Please enter a symbol</div>';
            return;
        }

        showLoading('quickAddBtn');
        document.getElementById('quickAddResult').innerHTML = '<div class="text-center py-2"><div class="loading mx-auto"></div></div>';
        
        await quickAddSymbol(symbol);
        hideLoading('quickAddBtn', '<i class="fas fa-plus mr-1"></i>Add');
        
        // Clear input
        document.getElementById('quickSymbolInput').value = '';
    });

    // Track if form is open to prevent auto-refresh interruption
    let isFormOpen = false;

    // Portfolio functions
    async function loadPortfolio() {
        // Don't refresh if form is open
        if (isFormOpen) {
            return Promise.resolve();
        }
        
        try {
            const response = await fetch('/api/portfolio');
            const data = await response.json();
            
            if (data.success && data.data) {
                const portfolio = data.data;
                // Always display portfolio, even if empty
                displayPortfolio(portfolio);
            } else {
                // If API call failed or returned no data, show empty state with form
                showEmptyPortfolio();
            }
            return Promise.resolve();
        } catch (error) {
            console.error('Error loading portfolio:', error);
            // Only show error if form is not open
            if (!isFormOpen) {
                document.getElementById('portfolioContent').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-3"></i>
                        <h3 class="text-lg font-semibold text-red-600 mb-2">Error loading portfolio</h3>
                        <p class="text-gray-500 mb-4">${error.message || 'Failed to load portfolio data'}</p>
                        <button onclick="showAddHoldingForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Holding
                        </button>
                    </div>
                `;
            }
            return Promise.reject(error);
        }
    }

    function showEmptyPortfolio() {
        document.getElementById('portfolioContent').innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-wallet text-gray-400 text-4xl mb-3"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">No holdings yet</h3>
                <p class="text-gray-500 mb-4">Start building your portfolio by adding your first holding</p>
                <button onclick="showAddHoldingForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Holding
                </button>
            </div>
        `;
    }

    function displayPortfolio(portfolio) {
        // Handle empty portfolio
        if (!portfolio.holdings || portfolio.holdings.length === 0 || portfolio.total_holdings === 0) {
            showEmptyPortfolio();
            return;
        }

        // Ensure all values are numbers
        const totalCost = parseFloat(portfolio.total_cost || 0);
        const totalValue = parseFloat(portfolio.total_value || 0);
        const totalGainLoss = parseFloat(portfolio.total_gain_loss || 0);
        const totalGainLossPercent = parseFloat(portfolio.total_gain_loss_percent || 0);
        
        const gainLossClass = totalGainLoss >= 0 ? 'text-green-600' : 'text-red-600';
        const gainLossIcon = totalGainLoss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
        
        const holdingsHtml = portfolio.holdings.map(holding => {
            const h = holding.holding;
            const quote = holding.quote;
            const hGainLossClass = (h.gain_loss || 0) >= 0 ? 'text-green-600' : 'text-red-600';
            const hGainLossIcon = (h.gain_loss || 0) >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const currentPrice = parseFloat(h.current_price || (quote ? quote.price : h.purchase_price));
            const currentValue = parseFloat(h.current_value || (currentPrice * h.quantity));
            const totalCost = parseFloat(h.purchase_price) * parseFloat(h.quantity);
            const gainLoss = h.gain_loss !== null && h.gain_loss !== undefined 
                ? parseFloat(h.gain_loss) 
                : (currentValue - totalCost);
            const gainLossPercent = h.gain_loss_percent !== null && h.gain_loss_percent !== undefined 
                ? parseFloat(h.gain_loss_percent) 
                : (totalCost > 0 ? ((gainLoss / totalCost) * 100) : 0);
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-2 sm:px-4">
                        <div class="font-semibold text-sm">${h.symbol}</div>
                        <div class="text-xs text-gray-500 hidden sm:block">${holding.name || h.asset_type}</div>
                    </td>
                    <td class="py-3 px-2 sm:px-4 text-xs sm:text-sm">${parseFloat(h.quantity).toFixed(4)}</td>
                    <td class="py-3 px-2 sm:px-4 text-xs sm:text-sm hidden sm:table-cell">$${parseFloat(h.purchase_price).toFixed(2)}</td>
                    <td class="py-3 px-2 sm:px-4 text-xs sm:text-sm">$${currentPrice.toFixed(2)}</td>
                    <td class="py-3 px-2 sm:px-4 text-xs sm:text-sm hidden md:table-cell">$${currentValue.toFixed(2)}</td>
                    <td class="py-3 px-2 sm:px-4">
                        <div class="${hGainLossClass} text-xs sm:text-sm">
                            <i class="fas ${hGainLossIcon} mr-1"></i>
                            $${Math.abs(gainLoss).toFixed(2)}
                        </div>
                        <div class="text-xs ${hGainLossClass}">
                            ${gainLossPercent >= 0 ? '+' : ''}${gainLossPercent.toFixed(2)}%
                        </div>
                    </td>
                    <td class="py-3 px-2 sm:px-4">
                        <div class="flex space-x-1 sm:space-x-2">
                            <button onclick="editHolding('${h.id}', '${h.symbol}', ${parseFloat(h.quantity)}, ${parseFloat(h.purchase_price)})" class="text-blue-600 hover:text-blue-800 text-sm p-1 sm:p-0" title="Edit holding">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteHolding('${h.id}')" class="text-red-600 hover:text-red-800 text-sm p-1 sm:p-0" title="Delete holding">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        const portfolioContent = document.getElementById('portfolioContent');
        portfolioContent.innerHTML = `
                <div class="mb-6">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Total Cost</div>
                        <div class="text-xl font-bold">$${totalCost.toFixed(2)}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Current Value</div>
                        <div class="text-xl font-bold">$${totalValue.toFixed(2)}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Total Gain/Loss</div>
                        <div class="text-xl font-bold ${gainLossClass}">
                            <i class="fas ${gainLossIcon} mr-1"></i>
                            $${Math.abs(totalGainLoss).toFixed(2)}
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Return %</div>
                        <div class="text-xl font-bold ${gainLossClass}">
                            ${totalGainLossPercent >= 0 ? '+' : ''}${totalGainLossPercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleHoldingsTable()" id="toggleHoldingsBtn" class="text-gray-600 hover:text-gray-800 transition duration-200" title="Minimize/Expand holdings">
                            <i class="fas fa-chevron-down" id="toggleHoldingsIcon"></i>
                        </button>
                        <h3 class="text-lg font-semibold">Holdings (${portfolio.total_holdings || 0})</h3>
                    </div>
                    <button onclick="showAddHoldingForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-plus mr-1"></i>Add Holding
                    </button>
                </div>
                <div id="holdingsTableContainer" class="table-responsive overflow-x-auto -mx-4 sm:mx-0">
                    <table class="min-w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700">Symbol</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700">Qty</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden sm:table-cell">Purchase</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700">Current</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700 hidden md:table-cell">Value</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700">G/L</th>
                                <th class="py-2 px-2 sm:px-4 text-left text-xs sm:text-sm font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${holdingsHtml}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Restore collapse state after displaying portfolio
        setTimeout(restoreHoldingsTableState, 50);
    }

    function showAddHoldingForm() {
        // Mark form as open and pause auto-refresh
        isFormOpen = true;
        stopPortfolioAutoRefresh();
        
        const formHtml = `
            <div class="bg-white border-2 border-yellow-500 rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-plus-circle text-yellow-500 mr-2"></i>Add New Holding
                </h3>
                <form id="addHoldingForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Symbol/Ticker *</label>
                            <input type="text" id="holdingSymbol" placeholder="e.g., AAPL, MSFT, BTC-USD" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" 
                                   required autofocus>
                            <p class="text-xs text-gray-500 mt-1">Enter any ticker symbol (stocks, ETFs, crypto)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                            <input type="number" id="holdingQuantity" step="0.0001" min="0" placeholder="0.0000" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" 
                                   required>
                            <p class="text-xs text-gray-500 mt-1">Number of shares/coins you own</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Price (Optional)</label>
                            <input type="number" id="holdingPurchasePrice" step="0.01" min="0" placeholder="Leave empty to use current market price" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <p class="text-xs text-gray-500 mt-1">Price per share/coin when purchased. If left empty, current market price will be used.</p>
                        </div>
                    </div>
                    <div id="addHoldingError" class="hidden bg-red-50 border border-red-200 rounded-md p-3 text-red-700 text-sm"></div>
                    <div class="flex space-x-2 pt-2">
                        <button type="submit" id="addHoldingBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-md transition duration-200 font-medium">
                            <i class="fas fa-plus mr-1"></i>Add Holding
                        </button>
                        <button type="button" onclick="closeAddHoldingForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition duration-200">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        const portfolioContent = document.getElementById('portfolioContent');
        portfolioContent.innerHTML = formHtml;
        
        // Remove any existing event listeners by cloning the form
        const form = document.getElementById('addHoldingForm');
        if (form) {
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
        }
        
        document.getElementById('addHoldingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('addHoldingError');
            const submitBtn = document.getElementById('addHoldingBtn');
            const originalBtnText = submitBtn.innerHTML;
            
            // Clear previous errors
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            
            // Get form values
            const symbol = document.getElementById('holdingSymbol').value.trim().toUpperCase();
            const quantityStr = document.getElementById('holdingQuantity').value.trim();
            const purchasePriceStr = document.getElementById('holdingPurchasePrice').value.trim();
            
            // Validate inputs
            if (!symbol) {
                showError('Please enter a symbol/ticker');
                return;
            }
            
            if (!quantityStr || isNaN(parseFloat(quantityStr)) || parseFloat(quantityStr) <= 0) {
                showError('Please enter a valid quantity greater than 0');
                return;
            }
            
            const quantity = parseFloat(quantityStr);
            const purchasePrice = purchasePriceStr && !isNaN(parseFloat(purchasePriceStr)) && parseFloat(purchasePriceStr) > 0
                ? parseFloat(purchasePriceStr)
                : null;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
            
            try {
                const requestBody = {
                    symbol,
                    quantity,
                };
                
                // Only include purchase_price if provided
                if (purchasePrice !== null) {
                    requestBody.purchase_price = purchasePrice;
                }
                
                const response = await fetch('/api/portfolio/holdings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                if (data.success) {
                    // Success - close form and reload portfolio
                    isFormOpen = false;
                    startPortfolioAutoRefresh(); // Resume auto-refresh
                    
                    if (data.data && data.data.merged) {
                        // Show success message for merged holdings
                        const successMsg = document.createElement('div');
                        successMsg.className = 'bg-green-50 border border-green-200 rounded-md p-3 text-green-700 text-sm mb-4';
                        successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + (data.data.message || 'Holding merged successfully');
                        errorDiv.parentNode.insertBefore(successMsg, errorDiv);
                        setTimeout(() => successMsg.remove(), 5000);
                    }
                    loadPortfolio();
                } else {
                    showError(data.error || 'Failed to add holding. Please check the symbol and try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('addHoldingError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        // Focus on symbol input
        setTimeout(() => {
            const symbolInput = document.getElementById('holdingSymbol');
            if (symbolInput) {
                symbolInput.focus();
            }
        }, 100);
    }

    function closeAddHoldingForm() {
        // Mark form as closed and resume auto-refresh
        isFormOpen = false;
        startPortfolioAutoRefresh();
        loadPortfolio();
    }

    function editHolding(holdingId, symbol, quantity, purchasePrice) {
        // Mark form as open to prevent auto-refresh interruption
        isFormOpen = true;
        stopPortfolioAutoRefresh();
        
        const formHtml = `
            <div class="bg-white border-2 border-blue-500 rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-edit text-blue-500 mr-2"></i>Edit Holding: ${symbol}
                </h3>
                <form id="editHoldingForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                            <input type="text" id="editHoldingSymbol" value="${symbol}" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100" 
                                   disabled>
                            <p class="text-xs text-gray-500 mt-1">Symbol cannot be changed</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity *</label>
                            <input type="number" id="editHoldingQuantity" step="0.0001" min="0" value="${quantity.toFixed(4)}" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   required autofocus>
                            <p class="text-xs text-gray-500 mt-1">Number of shares/coins you own</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Price *</label>
                            <input type="number" id="editHoldingPurchasePrice" step="0.01" min="0" value="${purchasePrice.toFixed(2)}" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   required>
                            <p class="text-xs text-gray-500 mt-1">Price per share/coin when purchased</p>
                        </div>
                    </div>
                    <div id="editHoldingError" class="hidden bg-red-50 border border-red-200 rounded-md p-3 text-red-700 text-sm"></div>
                    <div class="flex space-x-2 pt-2">
                        <button type="submit" id="editHoldingBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition duration-200 font-medium">
                            <i class="fas fa-save mr-1"></i>Save Changes
                        </button>
                        <button type="button" onclick="closeEditHoldingForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition duration-200">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        const portfolioContent = document.getElementById('portfolioContent');
        portfolioContent.innerHTML = formHtml;
        
        // Remove any existing event listeners by cloning the form
        const form = document.getElementById('editHoldingForm');
        if (form) {
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
        }
        
        document.getElementById('editHoldingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('editHoldingError');
            const submitBtn = document.getElementById('editHoldingBtn');
            const originalBtnText = submitBtn.innerHTML;
            
            // Clear previous errors
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            
            // Get form values
            const quantityStr = document.getElementById('editHoldingQuantity').value.trim();
            const purchasePriceStr = document.getElementById('editHoldingPurchasePrice').value.trim();
            
            // Validate inputs
            if (!quantityStr || isNaN(parseFloat(quantityStr)) || parseFloat(quantityStr) <= 0) {
                showEditError('Please enter a valid quantity greater than 0');
                return;
            }
            
            if (!purchasePriceStr || isNaN(parseFloat(purchasePriceStr)) || parseFloat(purchasePriceStr) <= 0) {
                showEditError('Please enter a valid purchase price greater than 0');
                return;
            }
            
            const quantity = parseFloat(quantityStr);
            const purchasePrice = parseFloat(purchasePriceStr);
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';
            
            try {
                const requestBody = {
                    quantity: quantity,
                    purchase_price: purchasePrice
                };
                
                const response = await fetch(`/api/portfolio/holdings/${holdingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                if (data.success) {
                    // Success - close form and reload portfolio
                    isFormOpen = false;
                    startPortfolioAutoRefresh(); // Resume auto-refresh
                    loadPortfolio();
                } else {
                    showEditError(data.error || 'Failed to update holding. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            } catch (error) {
                showEditError('Network error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
        
        function showEditError(message) {
            const errorDiv = document.getElementById('editHoldingError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        // Focus on quantity input
        setTimeout(() => {
            const quantityInput = document.getElementById('editHoldingQuantity');
            if (quantityInput) {
                quantityInput.focus();
                quantityInput.select();
            }
        }, 100);
    }

    function closeEditHoldingForm() {
        // Mark form as closed and resume auto-refresh
        isFormOpen = false;
        startPortfolioAutoRefresh();
        loadPortfolio();
    }

    async function deleteHolding(holdingId) {
        if (!confirm('Are you sure you want to delete this holding?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/portfolio/holdings/${holdingId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            if (data.success) {
                loadPortfolio();
            } else {
                alert('Error: ' + (data.error || 'Failed to delete holding'));
            }
        } catch (error) {
            alert('Error deleting holding: ' + error);
        }
    }

    // Holdings table collapse state
    let holdingsTableCollapsed = false;
    
    function toggleHoldingsTable() {
        const container = document.getElementById('holdingsTableContainer');
        const icon = document.getElementById('toggleHoldingsIcon');
        
        if (!container || !icon) return;
        
        holdingsTableCollapsed = !holdingsTableCollapsed;
        
        if (holdingsTableCollapsed) {
            container.style.display = 'none';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            icon.parentElement.title = 'Expand holdings';
        } else {
            container.style.display = 'block';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            icon.parentElement.title = 'Minimize holdings';
        }
        
        // Save state to localStorage
        localStorage.setItem('holdingsTableCollapsed', holdingsTableCollapsed.toString());
    }
    
    function restoreHoldingsTableState() {
        const savedState = localStorage.getItem('holdingsTableCollapsed');
        if (savedState === 'true') {
            holdingsTableCollapsed = true;
            const container = document.getElementById('holdingsTableContainer');
            const icon = document.getElementById('toggleHoldingsIcon');
            
            if (container && icon) {
                container.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                icon.parentElement.title = 'Expand holdings';
            }
        }
    }

    function refreshPortfolio() {
        const btn = document.getElementById('refreshPortfolioBtn');
        if (btn) {
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
            
            loadPortfolio().finally(() => {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    // Restore collapse state after refresh
                    restoreHoldingsTableState();
                }, 500);
            });
        } else {
            loadPortfolio();
            // Restore collapse state after refresh
            setTimeout(restoreHoldingsTableState, 100);
        }
    }

    // Auto-refresh portfolio every 30 seconds to show updated prices
    let portfolioRefreshInterval = null;
    function startPortfolioAutoRefresh() {
        // Don't start if form is open
        if (isFormOpen) {
            return;
        }
        
        // Clear any existing interval
        if (portfolioRefreshInterval) {
            clearInterval(portfolioRefreshInterval);
        }
        // Refresh every 30 seconds
        portfolioRefreshInterval = setInterval(() => {
            // Double-check form is not open before refreshing
            if (!isFormOpen) {
                loadPortfolio();
            }
        }, 30000); // 30 seconds
    }

    function stopPortfolioAutoRefresh() {
        if (portfolioRefreshInterval) {
            clearInterval(portfolioRefreshInterval);
            portfolioRefreshInterval = null;
        }
    }

    // Load data on page load
    refreshStats();
    loadPortfolio();
    
    // Restore holdings table state after initial load
    setTimeout(restoreHoldingsTableState, 500);
    
    // Start auto-refresh when page loads
    startPortfolioAutoRefresh();
    
    // Stop auto-refresh when page is hidden (to save resources)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopPortfolioAutoRefresh();
        } else {
            startPortfolioAutoRefresh();
            loadPortfolio(); // Refresh immediately when page becomes visible
        }
    });
</script>
{% endblock %} 